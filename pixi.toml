[workspace]
authors = ["Ondřej Čertík <ondrej@certik.us>"]
channels = [
    "https://prefix.dev/sdl",  # Prioritize our SDL3 packages
    "https://prefix.dev/certik-forge",  # Prioritize our packages
    "conda-forge"              # Fallback
]
name = "wasi"
platforms = ["osx-arm64", "linux-64", "win-64"]
version = "0.1.0"

[feature.wasm.tasks]
build_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena.wasm \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_wasm.c
"""

test_wasm = { cmd="wasmtime --dir . arena.wasm", depends-on=["build_wasm"] }

build_base_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I platform \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena_base.wasm \
    test_base_only.c \
    test_base.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_wasm.c
"""

test_base_wasm = { cmd="wasmtime --dir . arena_base.wasm", depends-on=["build_base_wasm"] }

build_wordfreq_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o wordfreq.wasm \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_wasm.c
"""

test_wordfreq_wasm = { cmd="wasmtime --dir . wordfreq.wasm test_wordfreq.txt", depends-on=["build_wordfreq_wasm"] }

build_hotel2gltf_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=1048576 \
    -o hotel2gltf.wasm \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_wasm.c
"""

test_hotel2gltf_wasm = { cmd="wasmtime --dir . hotel2gltf.wasm", depends-on=["build_hotel2gltf_wasm"] }

build_game_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I sdl/wasm \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=app_init \
    -Wl,--export=app_iterate \
    -Wl,--export=app_quit \
    -Wl,--export=__heap_base \
    -Wl,--initial-memory=7340032 \
    -o game.wasm \
    game.c \
    sdl/wasm/SDL_wasm.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/base_string.c \
    base/numconv.c \
    base/mem.c \
    base/io.c \
    base/base_io.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    stdlib/string.c \
    stdlib/stdlib.c \
    stdlib/stdio.c \
    platform/platform_wasm.c
"""

test_game_wasm = { cmd="echo 'WASM build successful: game.wasm'", depends-on=["build_game_wasm"] }


bundle_shaders = { cmd="./bundler shaders_manifest.txt shaders.bundle", depends-on=["build_bundler"] }

serve = { cmd="python server.py", depends-on=["test_game_wasm", "bundle_shaders"] }

[feature.wasm.dependencies]
clang = ">=20.1.4,<21"
lld = ">=20.1.4,<21"
python = ">=3.10"
wasmtime = ">=38.0.3,<39"

[feature.linux.tasks]
build_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o arena_linux \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_linux.c
"""

test_linux = { cmd="./arena_linux", depends-on=["build_linux"] }

build_wordfreq_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o wordfreq_linux \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_linux.c
"""

test_wordfreq_linux = { cmd="./wordfreq_linux test_wordfreq.txt", depends-on=["build_wordfreq_linux"] }

build_hotel2gltf_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o hotel2gltf_linux \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_linux.c
"""

test_hotel2gltf_linux = { cmd="./hotel2gltf_linux", depends-on=["build_hotel2gltf_linux"] }

[feature.linux.target.linux-64.dependencies]
clang = ">=20.1.4,<21"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"
spirv-tools = ">=2025.4,<2026"


[feature.macos.tasks]
build_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o arena_macos \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_macos = { cmd="./arena_macos", depends-on=["build_macos"] }

build_wordfreq_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o wordfreq_macos \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_wordfreq_macos = { cmd="./wordfreq_macos test_wordfreq.txt", depends-on=["build_wordfreq_macos"] }

build_hotel2gltf_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I platform \
    -I . \
    -o hotel2gltf_macos \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_hotel2gltf_macos = { cmd="./hotel2gltf_macos", depends-on=["build_hotel2gltf_macos"] }

[target.osx-arm64.dependencies]
python = ">=3.12"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"

[target.osx-arm64.tasks]
build_game = """
clang \
    -I$CONDA_PREFIX/include \
    -L$CONDA_PREFIX/lib \
    -Wl,-rpath,$CONDA_PREFIX/lib \
    -DPLATFORM_USE_EXTERNAL_STDLIB \
    -I base \
    -I platform \
    -I . \
    -lSDL3 \
    -lSDL3_image \
    -lSystem \
    -framework Metal -framework CoreGraphics -framework AppKit \
    -Wno-macro-redefined \
    -o game_macos \
    game.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    platform/platform_macos.c
"""

test_game = { cmd="./game_macos", depends-on=["build_game"] }

[target.linux-64.dependencies]
clang = ">=20.1.4,<21"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"
spirv-tools = ">=2025.4,<2026"

[target.linux-64.tasks]
build_game = """
clang \
    -I$CONDA_PREFIX/include \
    -L$CONDA_PREFIX/lib \
    -Wl,-rpath,$CONDA_PREFIX/lib \
    -DPLATFORM_USE_EXTERNAL_STDLIB \
    -I base \
    -I platform \
    -I . \
    -lSDL3 \
    -lSDL3_image \
    -lm \
    -Wno-macro-redefined \
    -o game_linux \
    game.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    platform/platform_linux.c
"""

test_game = { cmd="./game_linux", depends-on=["build_game"] }

[feature.macos.target.osx-arm64.dependencies]
# Use the system Clang on macOS
#clang = ">=20.1.4,<21"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"


[feature.windows.tasks]
build_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"platform" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    tests.obj \
    test_stdlib.obj \
    test_base.obj \
    stdio.obj \
    stdlib.obj \
    printf.obj \
    string.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    platform_windows.obj \
    /out:arena_windows.exe
"""

test_windows = { cmd="./arena_windows.exe", depends-on=["build_windows"] }

build_wordfreq_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"platform" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    wordfreq.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    platform_windows.obj \
    /out:wordfreq_windows.exe
"""

test_wordfreq_windows = { cmd="./wordfreq_windows.exe test_wordfreq.txt", depends-on=["build_wordfreq_windows"] }

build_hotel2gltf_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"platform" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    platform/platform_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    hotel2gltf.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    platform_windows.obj \
    /out:hotel2gltf_windows.exe
"""

test_hotel2gltf_windows = { cmd="./hotel2gltf_windows.exe", depends-on=["build_hotel2gltf_windows"] }

[target.win-64.dependencies]
python = ">=3.12"
cmake = ">=3.20"
ninja = ">=1.10"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"

[target.win-64.tasks]
build_game = """
cl \
    /nologo \
    /std:c11 \
    /Zc:preprocessor \
    /I"$CONDA_PREFIX/Library/include" \
    /I"base" \
    /I"platform" \
    /I"." \
    /DPLATFORM_USE_EXTERNAL_STDLIB \
    /MD \
    /c \
    game.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    platform/platform_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /LIBPATH:"$CONDA_PREFIX/Library/lib" \
    game.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    mat4.obj \
    base_math.obj \
    platform_windows.obj \
    SDL3.lib \
    SDL3_image.lib \
    shell32.lib \
    d3d12.lib \
    dxgi.lib \
    dxguid.lib \
    /out:game_windows.exe
"""

test_game = { cmd="./game_windows", depends-on=["build_game"] }

[feature.windows.target.win-64.dependencies]
# Note: MSVC is not available through conda-forge, so we rely on system installation
# Users need to have Visual Studio or Build Tools for Visual Studio installed
# The cl.exe and link.exe commands should be available in PATH
# SDL3 is included from prefix.dev as priority
cmake = ">=3.20"
ninja = ">=1.10"
sdl3 = "==3.3.3"
sdl3_image = "==3.3.0"


[tasks]
all = { depends-on=["test_wasm", "test_linux"] }
all_with_macos = { depends-on=["test_wasm", "test_linux", "test_macos"] }
all_with_windows = { depends-on=["test_wasm", "test_linux", "test_windows"] }
all_platforms = { depends-on=["test_wasm", "test_linux", "test_macos", "test_windows"] }
build_all = { depends-on=["build_wasm", "build_linux"] }
build_all_with_macos = { depends-on=["build_wasm", "build_linux", "build_macos"] }
build_all_with_windows = { depends-on=["build_wasm", "build_linux", "build_windows"] }
build_all_platforms = { depends-on=["build_wasm", "build_linux", "build_macos", "build_windows"] }

[dependencies]
# on macOS we want system Clang
#clang = ">=20.1.4,<21"
shell = "*"

[environments]
default = { solve-group = "default" }
wasm = ["wasm"]
linux = { features = ["linux"], solve-group = "linux" }
macos = { features = ["macos"], solve-group = "macos" }
windows = { features = ["windows"], solve-group = "windows" }

# Platform-specific task overrides
# On macOS, use system clang to avoid LTO library issues with conda clang
[feature.wasm.target.osx-arm64.tasks]
build_bundler = "/usr/bin/clang -o bundler bundler.c"

[feature.wasm.target.linux-64.tasks]
build_bundler = "clang -o bundler bundler.c"

[feature.wasm.target.win-64.tasks]
build_bundler = "clang -o bundler bundler.c"
