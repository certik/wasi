[project]
authors = ["Ondřej Čertík <ondrej@certik.us>"]
channels = ["conda-forge"]
name = "wasi"
platforms = ["osx-arm64", "linux-64", "win-64"]
version = "0.1.0"

[feature.wasm.tasks]
build_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena.wasm \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/assert.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/mem.c \
    base/assert.c \
    native/wasi_wasm.c
"""

test_wasm = { cmd="wasmtime arena.wasm", depends-on=["build_wasm"] }

build_base_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena_base.wasm \
    test_base_only.c \
    test_base.c \
    stdlib/assert.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/mem.c \
    base/assert.c \
    native/wasi_wasm.c
"""

test_base_wasm = { cmd="wasmtime arena_base.wasm", depends-on=["build_base_wasm"] }

[feature.wasm.dependencies]
clang = ">=20.1.4,<21"
lld = ">=20.1.4,<21"

[feature.linux.tasks]
build_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o arena_linux \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/assert.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/mem.c \
    base/assert.c \
    native/wasi_linux.c
"""

test_linux = { cmd="./arena_linux", depends-on=["build_linux"] }

[feature.linux.dependencies]
clang = ">=20.1.4,<21"

[feature.macos.tasks]
build_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o arena_macos \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/assert.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/mem.c \
    base/assert.c \
    native/wasi_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_macos = { cmd="./arena_macos", depends-on=["build_macos"] }

[feature.macos.dependencies]
# Use the system Clang on macOS
#clang = ">=20.1.4,<21"

[feature.windows.tasks]
build_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"native" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/assert.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/mem.c \
    base/assert.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    tests.obj \
    test_stdlib.obj \
    test_base.obj \
    assert.obj \
    stdio.obj \
    stdlib.obj \
    string.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    mem.obj \
    assert_base.obj \
    wasi_windows.obj \
    /out:arena_windows.exe
"""

test_windows = { cmd="arena_windows.exe", depends-on=["build_windows"] }

[feature.windows.dependencies]
# Note: MSVC is not available through conda-forge, so we rely on system installation
# Users need to have Visual Studio or Build Tools for Visual Studio installed
# The cl.exe and link.exe commands should be available in PATH

[tasks]
all = { depends-on=["test_wasm", "test_linux"] }
all_with_macos = { depends-on=["test_wasm", "test_linux", "test_macos"] }
all_with_windows = { depends-on=["test_wasm", "test_linux", "test_windows"] }
all_platforms = { depends-on=["test_wasm", "test_linux", "test_macos", "test_windows"] }
build_all = { depends-on=["build_wasm", "build_linux"] }
build_all_with_macos = { depends-on=["build_wasm", "build_linux", "build_macos"] }
build_all_with_windows = { depends-on=["build_wasm", "build_linux", "build_windows"] }
build_all_platforms = { depends-on=["build_wasm", "build_linux", "build_macos", "build_windows"] }

[dependencies]
# on macOS we want system Clang
#clang = ">=20.1.4,<21"

[environments]
default = { features = ["linux"], solve-group = "default" }
wasm = ["wasm"]
linux = { features = ["linux"], solve-group = "linux" }
macos = { features = ["macos"], solve-group = "macos" }
windows = { features = ["windows"], solve-group = "windows" }
