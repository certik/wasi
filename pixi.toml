[project]
authors = ["Ondřej Čertík <ondrej@certik.us>"]
channels = ["conda-forge"]
name = "wasi"
platforms = ["osx-arm64", "linux-64"]
version = "0.1.0"

[feature.wasm.tasks]
build_wasm = """
clang \
    --target=wasm32-wasi \
    -nostdlib \
    -fno-builtin \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena.wasm \
    standalone_arena.c
"""

test_wasm = { cmd="wasmtime arena.wasm || echo 'wasmtime not found, install separately'", depends-on=["build_wasm"] }

[feature.wasm.dependencies]
clang = ">=20.1.4,<21"
lld = ">=20.1.4,<21"

[feature.linux.tasks]
build_linux = { cmd="""
clang \
    -nostdlib \
    -fno-builtin \
    -o arena_linux \
    standalone_arena.c
""", inputs = ["standalone_arena.c"] }

test_linux = { cmd="./arena_linux", depends-on=["build_linux"] }

[feature.linux.dependencies]
clang = ">=20.1.4,<21"

[feature.macos.tasks]
build_macos = { cmd="""
clang \
    -nostdlib \
    -fno-builtin \
    -o arena_macos \
    standalone_arena.c \
    -lSystem \
    -Wl,-e,__start
""", inputs = ["standalone_arena.c"] }

test_macos = { cmd="./arena_macos", depends-on=["build_macos"] }

[feature.macos.dependencies]
clang = ">=20.1.4,<21"

[tasks]
all = { depends-on=["test_wasm", "test_linux"] }
all_with_macos = { depends-on=["test_wasm", "test_linux", "test_macos"] }
build_all = { depends-on=["build_wasm", "build_linux"] }
build_all_with_macos = { depends-on=["build_wasm", "build_linux", "build_macos"] }

[dependencies]
clang = ">=20.1.4,<21"

[environments]
default = { features = ["linux"], solve-group = "default" }
wasm = ["wasm"]
linux = { features = ["linux"], solve-group = "linux" }
macos = { features = ["macos"], solve-group = "macos" }
