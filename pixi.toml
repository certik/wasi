[project]
authors = ["Ondřej Čertík <ondrej@certik.us>"]
channels = ["conda-forge"]
name = "wasi"
platforms = ["osx-arm64", "linux-64", "win-64"]
version = "0.1.0"

[feature.wasm.tasks]
build_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena.wasm \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_wasm.c
"""

test_wasm = { cmd="wasmtime --dir . arena.wasm", depends-on=["build_wasm"] }

build_base_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o arena_base.wasm \
    test_base_only.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_wasm.c
"""

test_base_wasm = { cmd="wasmtime --dir . arena_base.wasm", depends-on=["build_base_wasm"] }

build_wordfreq_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=131072 \
    -o wordfreq.wasm \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_wasm.c
"""

test_wordfreq_wasm = { cmd="wasmtime --dir . wordfreq.wasm test_wordfreq.txt", depends-on=["build_wordfreq_wasm"] }

build_gm_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=find_start_position \
    -Wl,--export=generate_mesh \
    -Wl,--export=gm_frame \
    -Wl,--export=__heap_base \
    -Wl,--initial-memory=1048576 \
    -o gm.wasm \
    gm.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/base_string.c \
    base/numconv.c \
    base/mem.c \
    base/io.c \
    base/base_io.c \
    base/assert.c \
    base/exit.c \
    native/wasi_wasm.c \
    webgpu/webgpu_wasm.c
"""

test_gm_wasm = { cmd="echo 'WASM build successful: gm.wasm'", depends-on=["build_gm_wasm"] }

build_hotel2gltf_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=__heap_base \
    -Wl,--export=_start \
    -Wl,--initial-memory=1048576 \
    -o hotel2gltf.wasm \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_wasm.c
"""

test_hotel2gltf_wasm = { cmd="wasmtime --dir . hotel2gltf.wasm", depends-on=["build_hotel2gltf_wasm"] }

build_mousecircle_wasm = """
clang \
    --target=wasm32-wasi \
    -Os \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I sdl/wasm \
    -I . \
    -Wl,--no-entry \
    -Wl,--export=app_init \
    -Wl,--export=app_iterate \
    -Wl,--export=app_quit \
    -Wl,--export=__heap_base \
    -Wl,--initial-memory=2097152 \
    -o mousecircle.wasm \
    MouseCircle_standalone.c \
    sdl/wasm/SDL_wasm.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/base_string.c \
    base/numconv.c \
    base/mem.c \
    base/io.c \
    base/base_io.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    native/wasi_wasm.c
"""

test_mousecircle_wasm = { cmd="echo 'WASM build successful: mousecircle.wasm'", depends-on=["build_mousecircle_wasm"] }

[feature.wasm.dependencies]
clang = ">=20.1.4,<21"
lld = ">=20.1.4,<21"

[feature.linux.tasks]
build_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o arena_linux \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_linux.c
"""

test_linux = { cmd="./arena_linux", depends-on=["build_linux"] }

build_wordfreq_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o wordfreq_linux \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_linux.c
"""

test_wordfreq_linux = { cmd="./wordfreq_linux test_wordfreq.txt", depends-on=["build_wordfreq_linux"] }

build_gm_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o gm_linux \
    gm.c \
    gm_test.c \
    webgpu/webgpu_mock.c \
    platform_mock.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_linux.c
"""

test_gm_linux = { cmd="./gm_linux", depends-on=["build_gm_linux"] }

build_hotel2gltf_linux = """
clang \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o hotel2gltf_linux \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_linux.c
"""

test_hotel2gltf_linux = { cmd="./hotel2gltf_linux", depends-on=["build_hotel2gltf_linux"] }

build_mousecircle_linux = """
clang \
    -I$CONDA_PREFIX/include \
    -L$CONDA_PREFIX/lib \
    -Wl,-rpath,$CONDA_PREFIX/lib \
    -DWASI_LINUX_SKIP_ENTRY \
    -I base \
    -I native \
    -I . \
    -lSDL3 \
    -lm \
    -Wno-macro-redefined \
    -o mousecircle_linux \
    MouseCircle_standalone.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    native/wasi_linux.c
"""

test_mousecircle_linux = { cmd="./mousecircle_linux", depends-on=["build_mousecircle_linux"] }

[feature.linux.dependencies]
clang = ">=20.1.4,<21"
sdl3 = ">=3.2.24,<4"

[feature.macos.tasks]
build_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o arena_macos \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_macos = { cmd="./arena_macos", depends-on=["build_macos"] }

build_wordfreq_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o wordfreq_macos \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_wordfreq_macos = { cmd="./wordfreq_macos test_wordfreq.txt", depends-on=["build_wordfreq_macos"] }

build_gm_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o gm_macos \
    gm.c \
    gm_test.c \
    webgpu/webgpu_mock.c \
    platform_mock.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_gm_macos = { cmd="./gm_macos", depends-on=["build_gm_macos"] }

build_hotel2gltf_macos = """
clang \
    -g \
    -nostdlib \
    -nostdinc \
    -fno-builtin \
    -I base \
    -I stdlib \
    -I native \
    -I . \
    -o hotel2gltf_macos \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_macos.c \
    -lSystem \
    -Wl,-e,__start
"""

test_hotel2gltf_macos = { cmd="./hotel2gltf_macos", depends-on=["build_hotel2gltf_macos"] }

build_mousecircle_sdl = """
clang \
    -I$CONDA_PREFIX/include \
    -L$CONDA_PREFIX/lib \
    -Wl,-rpath,$CONDA_PREFIX/lib \
    -DWASI_MACOS_SKIP_ENTRY \
    -I base \
    -I native \
    -I . \
    -lSDL3 \
    -lSystem \
    -framework Metal -framework CoreGraphics -framework AppKit \
    -Wno-macro-redefined \
    -o mousecircle_sdl \
    MouseCircle_standalone.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    native/wasi_macos.c
"""

test_mousecircle_sdl = { cmd="./mousecircle_sdl", depends-on=["build_mousecircle_sdl"] }

[feature.macos.dependencies]
# Use the system Clang on macOS
#clang = ">=20.1.4,<21"
sdl3 = ">=3.2.24,<4"

[feature.windows.tasks]
build_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"native" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    tests.c \
    test_stdlib.c \
    test_base.c \
    stdlib/stdio.c \
    stdlib/stdlib.c \
    stdlib/printf.c \
    stdlib/string.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    tests.obj \
    test_stdlib.obj \
    test_base.obj \
    stdio.obj \
    stdlib.obj \
    printf.obj \
    string.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    wasi_windows.obj \
    /out:arena_windows.exe
"""

test_windows = { cmd="arena_windows.exe", depends-on=["build_windows"] }

build_wordfreq_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"native" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    wordfreq.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    wordfreq.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    wasi_windows.obj \
    /out:wordfreq_windows.exe
"""

test_wordfreq_windows = { cmd="wordfreq_windows.exe test_wordfreq.txt", depends-on=["build_wordfreq_windows"] }

build_gm_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"native" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    gm.c \
    gm_test.c \
    webgpu/webgpu_mock.c \
    platform_mock.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    gm.obj \
    gm_test.obj \
    webgpu_mock.obj \
    platform_mock.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    wasi_windows.obj \
    /out:gm_windows.exe
"""

test_gm_windows = { cmd="gm_windows.exe", depends-on=["build_gm_windows"] }

build_hotel2gltf_windows = """
cl \
    /nologo \
    /X \
    /std:c11 \
    /Zc:preprocessor \
    /I"base" \
    /I"stdlib" \
    /I"native" \
    /I"." \
    /GS- \
    /Gs0 \
    /kernel \
    /c \
    hotel2gltf.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /nodefaultlib \
    /entry:_start \
    kernel32.lib \
    shell32.lib \
    hotel2gltf.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    wasi_windows.obj \
    /out:hotel2gltf_windows.exe
"""

test_hotel2gltf_windows = { cmd="hotel2gltf_windows.exe", depends-on=["build_hotel2gltf_windows"] }

build_mousecircle_windows = """
cl \
    /nologo \
    /std:c11 \
    /Zc:preprocessor \
    /I"C:/SDL3/include" \
    /I"base" \
    /I"native" \
    /I"." \
    /DWASI_WINDOWS_SKIP_ENTRY \
    /MD \
    /c \
    MouseCircle_standalone.c \
    base/base_io.c \
    base/buddy.c \
    base/arena.c \
    base/scratch.c \
    base/format.c \
    base/io.c \
    base/base_string.c \
    base/mem.c \
    base/numconv.c \
    base/assert.c \
    base/exit.c \
    base/mat4.c \
    base/base_math.c \
    native/wasi_windows.c \
    && \
link \
    /nologo \
    /subsystem:console \
    /LIBPATH:"C:/SDL3/lib" \
    MouseCircle_standalone.obj \
    base_io.obj \
    buddy.obj \
    arena.obj \
    scratch.obj \
    format.obj \
    io.obj \
    base_string.obj \
    mem.obj \
    numconv.obj \
    exit.obj \
    assert.obj \
    mat4.obj \
    base_math.obj \
    wasi_windows.obj \
    SDL3.lib \
    shell32.lib \
    d3d12.lib \
    dxgi.lib \
    dxguid.lib \
    /out:mousecircle_windows.exe
"""

test_mousecircle_windows = { cmd="./mousecircle_windows", depends-on=["build_mousecircle_windows"] }

[feature.windows.dependencies]
# Note: MSVC is not available through conda-forge, so we rely on system installation
# Users need to have Visual Studio or Build Tools for Visual Studio installed
# The cl.exe and link.exe commands should be available in PATH
# SDL3 is built from source in CI (see .github/workflows/CI.yml)
cmake = ">=3.20"
ninja = ">=1.10"

[tasks]
build_bundler = "cc -o bundler bundler.c"
bundle_shaders = { cmd="./bundler shaders_manifest.txt shaders.bundle", depends-on=["build_bundler"] }
serve = { cmd="python3 server.py", depends-on=["test_gm_wasm"] }
serve2 = { cmd="python3 server.py", depends-on=["test_mousecircle_wasm", "bundle_shaders"] }
all = { depends-on=["test_wasm", "test_linux"] }
all_with_macos = { depends-on=["test_wasm", "test_linux", "test_macos"] }
all_with_windows = { depends-on=["test_wasm", "test_linux", "test_windows"] }
all_platforms = { depends-on=["test_wasm", "test_linux", "test_macos", "test_windows"] }
build_all = { depends-on=["build_wasm", "build_linux"] }
build_all_with_macos = { depends-on=["build_wasm", "build_linux", "build_macos"] }
build_all_with_windows = { depends-on=["build_wasm", "build_linux", "build_windows"] }
build_all_platforms = { depends-on=["build_wasm", "build_linux", "build_macos", "build_windows"] }

[dependencies]
# on macOS we want system Clang
#clang = ">=20.1.4,<21"

[environments]
default = { features = ["linux"], solve-group = "default" }
wasm = ["wasm"]
linux = { features = ["linux"], solve-group = "linux" }
macos = { features = ["macos"], solve-group = "macos" }
windows = { features = ["windows"], solve-group = "windows" }
